@using TestResultBrowser.Web.Models
@using TestResultBrowser.Web.Services
@using MudBlazor
@inject ITestReportUrlService TestReportUrlService
@inject IReportAssetService ReportAssetService

@if (IsOpen && TestResult != null)
{
    <div class="modal-backdrop fade show" style="display: block; z-index: 9998;"></div>
    <div class="modal fade show" style="display: block; z-index: 9999;" role="dialog">
        <div class="modal-dialog modal-xl" style="max-height: 90vh; display: flex; flex-direction: column; max-width: 92vw;">
            <div class="modal-content" style="display: flex; flex-direction: column; max-height: 90vh;">
                <!-- Header -->
                <div class="modal-header">
                    <h5 class="modal-title">Test Details</h5>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>

                <!-- Body -->
                <div class="modal-body" style="overflow-y: auto; flex: 1; max-height: calc(90vh - 120px);">
                    <div class="test-details-grid">
                        <div class="test-details-main">
                            <!-- Build -->
                            <div class="mb-3">
                                <h6>Build</h6>
                                <p><strong>@(ActiveTest?.BuildId ?? BuildId ?? TestResult.BuildId ?? "Unknown")</strong></p>
                            </div>

                            <!-- Test Name -->
                            <div class="mb-3">
                                <h6>Test Name</h6>
                                <p>@TestResult.TestFullName</p>
                            </div>

                            <!-- Error Message -->
                            @if (!string.IsNullOrEmpty(ActiveTest?.ErrorMessage))
                            {
                                <div class="mb-3">
                                    <h6>Error Message</h6>
                                    <div style="background-color: #fff3cd; padding: 10px; border-radius: 4px; border-left: 4px solid #ff6b6b;">
                                        <p style="margin: 0; white-space: pre-wrap; word-break: break-word;">@ActiveTest.ErrorMessage</p>
                                    </div>
                                </div>
                            }

                            <!-- Test History -->
                            @if (History?.Count > 0)
                            {
                                <div class="mb-3">
                                    <h6>Test History</h6>
                                    <table class="table table-sm table-striped" style="font-size: 0.85rem;">
                                        <thead>
                                            <tr>
                                                <th>Build</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Error Message</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in History)
                                            {
                                                <tr class="history-row @(IsActiveHistory(item) ? "is-active" : string.Empty)" @onclick="(() => SelectHistory(item))">
                                                    <td style="width: 120px;"><strong>@item.BuildId</strong></td>
                                                    <td style="width: 140px;">@item.Timestamp.ToString("MM/dd/yyyy HH:mm")</td>
                                                    <td style="width: 80px;">
                                                        @if (item.Status == TestStatus.Fail)
                                                        {
                                                            <span style="color: #dc3545;">Failed</span>
                                                        }
                                                        else if (item.Status == TestStatus.Skip)
                                                        {
                                                            <span style="color: #d4a017;">Skipped</span>
                                                        }
                                                        else
                                                        {
                                                            <span style="color: #28a745;">Passed</span>
                                                        }
                                                    </td>
                                                    <td style="word-break: break-word;">
                                                        @if (!string.IsNullOrEmpty(item.ErrorMessage))
                                                        {
                                                            <span>@item.ErrorMessage</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }

                            <!-- Stack Trace -->
                            @if (!string.IsNullOrEmpty(ActiveTest?.StackTrace))
                            {
                                <div class="mb-3">
                                    <h6>Stack Trace</h6>
                                    <div style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;">
                                        <pre style="margin: 0; white-space: pre-wrap; word-break: break-word; font-size: 0.85rem;">@ActiveTest.StackTrace</pre>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="test-details-media">
                            <h6>
                                Media / Report
                                @if (ActiveTest != null)
                                {
                                    <span class="media-meta">@ActiveTest.BuildId Â· @ActiveTest.Timestamp.ToString("MM/dd/yyyy HH:mm")</span>
                                }
                            </h6>
                            @if (IsLoadingAssets)
                            {
                                <div class="media-loading">Loading report assets...</div>
                            }
                            else if (AssetInfo != null && (!string.IsNullOrEmpty(AssetInfo.ScreenshotUrl) || !string.IsNullOrEmpty(AssetInfo.VideoUrl)))
                            {
                                <div class="media-assets">
                                    @if (!string.IsNullOrEmpty(AssetInfo.ScreenshotUrl))
                                    {
                                        <img src="@AssetInfo.ScreenshotUrl" alt="Test screenshot" />
                                    }
                                    @if (!string.IsNullOrEmpty(AssetInfo.VideoUrl))
                                    {
                                        <video controls src="@AssetInfo.VideoUrl"></video>
                                    }
                                </div>
                            }
                            else if (ActiveTest != null && string.IsNullOrEmpty(ActiveTest.ReportDirectoryPath))
                            {
                                <div class="media-empty">
                                    No report assets available for this test.
                                </div>
                            }
                            @if (AssetInfo != null && (!string.IsNullOrEmpty(AssetInfo.ScreenshotUrl) || !string.IsNullOrEmpty(AssetInfo.VideoUrl)))
                            {
                                <div class="media-links">
                                    @if (!string.IsNullOrEmpty(AssetInfo.ScreenshotUrl))
                                    {
                                        <a class="btn btn-outline-secondary" target="_blank" href="@AssetInfo.ScreenshotUrl">Open Screenshot</a>
                                    }
                                    @if (!string.IsNullOrEmpty(AssetInfo.VideoUrl))
                                    {
                                        <a class="btn btn-outline-secondary" target="_blank" href="@AssetInfo.VideoUrl">Open Video</a>
                                    }
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(ActiveTest?.ReportDirectoryPath))
                            {
                                <div class="media-preview">
                                    <iframe title="Test report preview" src="@GetReportUrl()" sandbox="allow-same-origin allow-scripts"></iframe>
                                </div>
                                <div class="mt-2">
                                    <a class="btn btn-outline-secondary" target="_blank" href="@GetReportUrl()">Open Full Report</a>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Close">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public TestResult? TestResult { get; set; }

    [Parameter]
    public string? BuildId { get; set; }

    [Parameter]
    public List<TestResult>? History { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private string? selectedHistoryId;
    private ReportAssetInfo? AssetInfo { get; set; }
    private bool IsLoadingAssets { get; set; }

    private TestResult? ActiveTest => GetActiveTestResult();

    protected override async Task OnParametersSetAsync()
    {
        await LoadAssetsAsync();
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    private string GetReportUrl()
    {
        var reportPath = ActiveTest?.ReportDirectoryPath ?? string.Empty;
        return string.IsNullOrEmpty(reportPath)
            ? string.Empty
            : TestReportUrlService.GetReportUrl(reportPath) ?? string.Empty;
    }

    private async Task SelectHistory(TestResult item)
    {
        selectedHistoryId = item.Id;
        await LoadAssetsAsync();
    }

    private bool IsActiveHistory(TestResult item)
    {
        return string.Equals(selectedHistoryId, item.Id, StringComparison.OrdinalIgnoreCase);
    }

    private TestResult? GetActiveTestResult()
    {
        if (History == null || History.Count == 0)
        {
            return TestResult;
        }

        if (!string.IsNullOrEmpty(selectedHistoryId))
        {
            var match = History.FirstOrDefault(h => string.Equals(h.Id, selectedHistoryId, StringComparison.OrdinalIgnoreCase));
            if (match != null)
            {
                return match;
            }
        }

        return History[0];
    }

    private async Task LoadAssetsAsync()
    {
        if (!IsOpen || ActiveTest == null)
        {
            AssetInfo = null;
            IsLoadingAssets = false;
            return;
        }

        IsLoadingAssets = true;
        try
        {
            AssetInfo = await ReportAssetService.GetAssetsAsync(ActiveTest);
        }
        finally
        {
            IsLoadingAssets = false;
        }
    }
}

<style>
    .test-details-grid {
        display: grid;
        grid-template-columns: minmax(320px, 1.2fr) minmax(320px, 1fr);
        gap: 20px;
        align-items: start;
    }

    .test-details-media {
        position: sticky;
        top: 0;
    }

    .media-preview {
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
        background: #fff;
    }

    .media-preview iframe {
        width: 100%;
        height: 60vh;
        border: 0;
        background: #fff;
    }

    .media-empty {
        background: #f8f9fa;
        border: 1px dashed #c9c9c9;
        border-radius: 6px;
        padding: 16px;
        color: #666;
    }

    .media-loading {
        background: #f0f4f8;
        border: 1px solid #d8e1ea;
        border-radius: 6px;
        padding: 12px;
        color: #4b5563;
        font-size: 0.9rem;
        margin-bottom: 12px;
    }

    .media-assets {
        display: grid;
        gap: 12px;
        margin-bottom: 12px;
    }

    .media-assets img,
    .media-assets video {
        width: 100%;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        background: #fff;
    }

    .media-links {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
    }

    .media-meta {
        font-size: 0.78rem;
        font-weight: 500;
        color: #6b7280;
        margin-left: 6px;
    }

    .history-row {
        cursor: pointer;
    }

    .history-row.is-active {
        outline: 2px solid #5b67f2;
        outline-offset: -2px;
    }

    @@media (max-width: 1000px) {
        .test-details-grid {
            grid-template-columns: 1fr;
        }

        .media-preview iframe {
            height: 45vh;
        }
    }
</style>
