@using TestResultBrowser.Web.Models
@using TestResultBrowser.Web.Services
@using MudBlazor
@inject IUserDataService UserDataService
@inject ISnackbar Snackbar

@* Modal Backdrop *@
@if (IsOpen)
{
    <div class="modal-backdrop" @onclick="Cancel"></div>
    
    <div class="modal" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Filter Configuration</h5>
                    <button type="button" class="btn-close" @onclick="Cancel"></button>
                </div>
                <div class="modal-body">
                    <MudTextField @bind-Value="filterName" 
                                  Label="Filter Name" 
                                  Variant="Variant.Outlined" 
                                  Required="true"
                                  HelperText="Give this filter a memorable name"
                                  Class="mb-3" />
                    
                    <MudTextField @bind-Value="filterDescription" 
                                  Label="Description (Optional)" 
                                  Variant="Variant.Outlined" 
                                  Lines="3"
                                  HelperText="Describe what this filter is used for"
                                  Class="mb-3" />
                    
                    @* Summary of what will be saved *@
                    <MudPaper Class="pa-3" Outlined="true">
                        <MudText Typo="Typo.body2" Class="mb-2"><strong>Filter will save:</strong></MudText>
                        <MudText Typo="Typo.caption">• Configuration: @(CurrentFilter?.SelectedConfiguration ?? "None")</MudText>
                        <MudText Typo="Typo.caption">• Features: @(CurrentFilter?.Features.Count ?? 0) selected</MudText>
                        <MudText Typo="Typo.caption">• Builds to display: @(CurrentFilter?.NumberOfBuilds ?? 5)</MudText>
                    </MudPaper>
                    
                    @if (!string.IsNullOrWhiteSpace(errorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Class="mt-3">@errorMessage</MudAlert>
                    }
                </div>
                <div class="modal-footer">
                    <MudButton Color="Color.Secondary" Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveFilter" Disabled="@isSaving">
                        @if (isSaving)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>Save Filter</span>
                        }
                    </MudButton>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter]
    public SavedFilterConfiguration? CurrentFilter { get; set; }

    [Parameter]
    public EventCallback<SavedFilterConfiguration> OnFilterSaved { get; set; }

    [Parameter]
    public string DefaultUsername { get; set; } = "DefaultUser";

    private string filterName = string.Empty;
    private string filterDescription = string.Empty;
    private string errorMessage = string.Empty;
    private bool isSaving = false;

    protected override void OnParametersSet()
    {
        if (IsOpen && CurrentFilter != null)
        {
            // Reset form when dialog opens
            filterName = string.Empty;
            filterDescription = string.Empty;
            errorMessage = string.Empty;
        }
    }

    private async Task SaveFilter()
    {
        errorMessage = string.Empty;

        // Validation
        if (string.IsNullOrWhiteSpace(filterName))
        {
            errorMessage = "Filter name is required";
            return;
        }

        if (CurrentFilter == null)
        {
            errorMessage = "No filter data to save";
            return;
        }

        try
        {
            isSaving = true;

            // Create new filter configuration with current state
            var filter = new SavedFilterConfiguration
            {
                Name = filterName.Trim(),
                Description = filterDescription.Trim(),
                SavedBy = DefaultUsername,
                SavedDate = DateTime.UtcNow,
                Features = CurrentFilter.Features,
                SelectedConfiguration = CurrentFilter.SelectedConfiguration,
                NumberOfBuilds = CurrentFilter.NumberOfBuilds,
                Domains = CurrentFilter.Domains,
                Versions = CurrentFilter.Versions,
                NamedConfigs = CurrentFilter.NamedConfigs,
                Machines = CurrentFilter.Machines,
                DateFrom = CurrentFilter.DateFrom,
                DateTo = CurrentFilter.DateTo,
                OnlyFailures = CurrentFilter.OnlyFailures,
                HideFlakyTests = CurrentFilter.HideFlakyTests
            };

            var savedFilter = await UserDataService.SaveFilterAsync(filter);

            Snackbar.Add($"Filter '{filterName}' saved successfully!", Severity.Success);

            await OnFilterSaved.InvokeAsync(savedFilter);
            await Close();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving filter: {ex.Message}";
            Snackbar.Add("Failed to save filter", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task Cancel()
    {
        await Close();
    }

    private async Task Close()
    {
        filterName = string.Empty;
        filterDescription = string.Empty;
        errorMessage = string.Empty;
        await IsOpenChanged.InvokeAsync(false);
    }
}

<style>
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1040;
        width: 100vw;
        height: 100vh;
        background-color: #000;
        opacity: 0.5;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
        width: 100%;
        height: 100%;
        overflow: auto;
        outline: 0;
    }

    .modal-dialog {
        position: relative;
        width: auto;
        margin: 1.75rem auto;
        max-width: 500px;
    }

    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        pointer-events: auto;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 0.3rem;
        outline: 0;
    }

    .modal-header {
        display: flex;
        flex-shrink: 0;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-title {
        margin-bottom: 0;
        line-height: 1.5;
        font-size: 1.25rem;
        font-weight: 500;
    }

    .modal-body {
        position: relative;
        flex: 1 1 auto;
        padding: 1rem;
    }

    .modal-footer {
        display: flex;
        flex-wrap: wrap;
        flex-shrink: 0;
        align-items: center;
        justify-content: flex-end;
        padding: 0.75rem;
        border-top: 1px solid #dee2e6;
        gap: 0.5rem;
    }

    .btn-close {
        box-sizing: content-box;
        width: 1em;
        height: 1em;
        padding: 0.25em 0.25em;
        color: #000;
        background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e") center / 1em auto no-repeat;
        border: 0;
        border-radius: 0.25rem;
        cursor: pointer;
        opacity: 0.5;
    }

    .btn-close:hover {
        opacity: 0.75;
    }
</style>
