@page "/configuration-history"
@rendermode InteractiveServer
@using TestResultBrowser.Web.Models
@using TestResultBrowser.Web.Services
@using MudBlazor
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using TestResultBrowser.Web.Components
@inject IConfigurationHistoryService ConfigHistoryService
@inject IUserDataService UserDataService
@inject IFeatureGroupingService FeatureGroupingService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<PageTitle>Configuration History</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    
    @* Compact Header Bar: config + builds + load button in one line *@
    <MudPaper Class="mb-3 pa-3">
        <div class="header-bar">
            <MudButton Variant="Variant.Outlined"
                      Color="Color.Primary"
                      OnClick="OpenConfigurationDialog"
                      Class="header-control header-config text-left"
                      Style="justify-content: flex-start;">
                <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2"></MudIcon>
                @if (string.IsNullOrEmpty(selectedConfiguration))
                {
                    <span>Select configuration…</span>
                }
                else
                {
                    <span>@ConfigurationLabelHelper.GetConfigurationLabel(selectedConfiguration)</span>
                }
                <MudSpacer />
                <MudIcon Icon="@Icons.Material.Filled.MoreVert"></MudIcon>
            </MudButton>

            <MudNumericField Value="@numberOfBuilds"
                             ValueChanged="@(async (int newValue) => await OnNumberOfBuildsChanged(newValue))"
                             Min="1" Max="20"
                             Dense="true"
                             Variant="Variant.Outlined"
                             Class="header-control builds-field"
                             Placeholder="Builds" />

            <MudButton Variant="Variant.Filled"
                      Color="Color.Primary"
                      OnClick="RefreshData"
                      Disabled="@isLoading"
                      Class="header-control load-btn">
                @if (isLoading)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                }
                else
                {
                    <span>Load Data</span>
                }
            </MudButton>
        </div>
    </MudPaper>

    @* Content area (full width) *@
    <MudGrid Class="config-history-grid">
        <MudItem xs="12" md="12" Class="main-content">
            @* Quick Actions *@
            <MudPaper Class="mb-4 pa-2">
                <div class="d-flex gap-2">
                    <LoadFilterDropdown @ref="loadFilterDropdown" Username="@currentUsername" OnFilterLoaded="ApplyFilter" OnCopyLinkRequested="CopyFilterLink" />
                    <MudButton Variant="Variant.Outlined" Color="Color.Info" OnClick="OpenSaveFilterDialog" Disabled="@(historyResult == null)">
                        <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1" /> Save Filter
                    </MudButton>
                    <MudSpacer />
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="ExpandAll">Expand All</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="CollapseAll">Collapse All</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="OpenFeatureDialog" Disabled="@(historyResult == null)">Select Features</MudButton>
                    @if (selectedFeatureNames.Any())
                    {
                        <MudTooltip Text="@string.Join(", ", selectedFeatureNames)">
                            <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                                Filter active: @selectedFeatureNames.Count feature(s)
                            </MudChip>
                        </MudTooltip>
                    }
                </div>
            </MudPaper>

            @* Stats Section *@
            @if (historyResult != null)
            {
                <MudGrid Class="mb-4">
                    <MudItem xs="12" sm="6" md="2">
                        <MudCard Class="slim-card" Variant="Variant.Outlined">
                            <MudCardContent>
                                <MudText Typo="Typo.caption" Color="Color.Default">Latest Run</MudText>
                                <MudText Typo="Typo.h6">@historyResult.LatestBuildId</MudText>
                                <MudText Typo="Typo.caption">@historyResult.LatestBuildTime.ToString("MM/dd/yyyy HH:mm")</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>

                    <MudItem xs="12" sm="6" md="2">
                        <MudCard Class="slim-card" Variant="Variant.Outlined">
                            <MudCardContent>
                                <MudText Typo="Typo.caption" Color="Color.Default">Total Tests</MudText>
                                <MudText Typo="Typo.h6">@historyResult.TotalTests</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>

                    <MudItem xs="12" sm="6" md="2">
                        <MudCard Class="slim-card" Variant="Variant.Outlined">
                            <MudCardContent>
                                <MudText Typo="Typo.caption" Color="Color.Default">Passed</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Success">@historyResult.PassedTests (@historyResult.PassRatePercentage.ToString("F1")%)</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>

                    <MudItem xs="12" sm="6" md="2">
                        <MudCard Class="slim-card" Variant="Variant.Outlined" Style="cursor: pointer;" @onclick="ToggleFailedFilter">
                            <MudCardContent>
                                <MudText Typo="Typo.caption" Color="Color.Default">Failed</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Error">@historyResult.FailedTests</MudText>
                                <MudText Typo="Typo.caption" Style="font-size: 0.75rem; color: #999; margin-top: 4px;">@(showOnlyFailed ? "✓ Filtered" : "Click to filter")</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>

                    <MudItem xs="12" sm="6" md="2">
                        <MudCard Class="slim-card" Variant="Variant.Outlined">
                            <MudCardContent>
                                <MudText Typo="Typo.caption" Color="Color.Default">Skipped</MudText>
                                <MudText Typo="Typo.h6">@historyResult.SkippedTests</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>

                @* Hierarchical Tree View *@
                <MudPaper Class="pa-4">
                    @if (historyResult.HierarchyNodes.Count == 0)
                    {
                        <MudText Color="Color.Default" Typo="Typo.body2">No test results found for selected configuration.</MudText>
                    }
                    else
                    {
                        <div class="table-container" style="overflow-x: auto;">
                            @* Render hierarchy tree with filtering *@
                            @foreach (var domainNode in historyResult.HierarchyNodes)
                            {
                                var filtered = GetFilteredNode(domainNode);
                                @if (filtered != null)
                                {
                                    <HierarchyTreeView Node="filtered" 
                                                       HistoryColumns="historyResult.HistoryColumns"
                                                       OnTestSelected="@((testInfo) => SelectTest(testInfo))" />
                                }
                            }
                        </div>
                    }
                </MudPaper>
            }
            else if (isLoading)
            {
                <MudContainer Class="d-flex justify-center align-center" style="min-height: 400px;">
                    <MudProgressCircular Size="Size.Large" Indeterminate="true" />
                </MudContainer>
            }
            else if (!string.IsNullOrEmpty(selectedConfiguration))
            {
                <MudAlert Severity="Severity.Info">Select a configuration and click Refresh to load data.</MudAlert>
            }
        </MudItem>
    </MudGrid>
</MudContainer>

@if (showConfigurationDialog)
{
    <div class="modal-backdrop fade show" style="display: block; z-index: 9998;"></div>
    <div class="modal fade show" style="display: block; z-index: 9999;" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Configuration (@configurationMetadata.Count available)</h5>
                    <button type="button" class="btn-close" @onclick="() => showConfigurationDialog = false"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" placeholder="Search configurations..." 
                           @bind="searchText" @bind:event="oninput" />
                    
                    <div style="max-height: 500px; overflow-y: auto;">
                        @foreach (var configMeta in GetFilteredConfigurations())
                        {
                            <div style="padding: 12px; cursor: pointer; background-color: @(configMeta.Id == selectedConfiguration ? "#e3f2fd" : "transparent"); border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;"
                                 @onclick="@(() => SelectConfigurationFromDialog(configMeta.Id))">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">@ConfigurationLabelHelper.GetConfigurationLabel(configMeta.Id)</div>
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 2px;">Last updated: @configMeta.LastUpdateDisplay</div>
                                </div>
                                @if (configMeta.Id == selectedConfiguration)
                                {
                                    <span style="color: #1976d2; font-size: 1.2rem;">✓</span>
                                }
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showConfigurationDialog = false">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showFeatureDialog)
{
    <FeatureSelectionModal FeatureGroups="featureGroups"
                           SelectedFeatures="selectedFeatureNames"
                           OnApply="ApplyFeatureSelection"
                           OnCancel="CloseFeatureDialog" />
}

@* Test Details Modal *@
<TestDetailsModal IsOpen="@showTestDetailsDialog" 
                  TestResult="@GetSelectedTestResult()"
                  BuildId="@GetSelectedBuildId()"
                  History="@GetTestHistory()"
                  OnClose="@CloseTestDetails" />

@* Save Filter Dialog *@
<SaveFilterDialog IsOpen="@showSaveFilterDialog" 
                  IsOpenChanged="@((bool value) => showSaveFilterDialog = value)"
                  CurrentFilter="@GetCurrentFilterState()"
                  OnFilterSaved="OnFilterSaved"
                  DefaultUsername="@currentUsername" />

@code {
    [SupplyParameterFromQuery(Name = "config")]
    public string? ConfigFromUrl { get; set; }
    
    [SupplyParameterFromQuery(Name = "builds")]
    public int? BuildsFromUrl { get; set; }

    [SupplyParameterFromQuery(Name = "filterId")]
    public int? FilterIdFromUrl { get; set; }

    [SupplyParameterFromQuery(Name = "feature")]
    public string? FeatureFromUrl { get; set; }
    
    private List<string> availableConfigurations = new();
    private List<ConfigurationMetadata> configurationMetadata = new();
    private string selectedConfiguration = string.Empty;
    private ConfigurationHistoryResult? historyResult;
    private int numberOfBuilds = 5;
    private bool isLoading = false;
    private string searchText = string.Empty;
    private bool showConfigurationDialog = false;
    private bool showOnlyFailed = false;
    private SelectedTestInfo? selectedTestInfo = null;  // Track selected test with column info
    private bool showFeatureDialog = false;   // Controls feature selection dialog
    private bool showTestDetailsDialog = false;  // Controls test details modal
    private Dictionary<string, List<string>> featureGroups = new();  // Groups of features
    private HashSet<string> selectedFeatureNames = new();  // Currently selected features
    private bool showSaveFilterDialog = false;  // Controls save filter dialog
    private LoadFilterDropdown? loadFilterDropdown;  // Reference to load filter dropdown
    private string currentUsername = "DefaultUser";  // Current user (can be from auth later)
    private int? lastAppliedFilterId;  // Tracks the last applied filter for sharing
    private bool featureFromUrlApplied = false;
    private string? lastFeatureFromUrl;

    // Expand All protection
    private const int MAX_EXPAND_ALL_NODES = 5000;

    protected override async Task OnInitializedAsync()
    {
        var totalStopwatch = System.Diagnostics.Stopwatch.StartNew();

        var sw = System.Diagnostics.Stopwatch.StartNew();
        await LoadAvailableConfigurations();

        sw.Restart();
        // Apply saved filter from URL (if provided)
        var filterApplied = await ApplyFilterFromUrlAsync();

        // Load from URL parameters if present (has priority)
        if (!string.IsNullOrEmpty(ConfigFromUrl) && availableConfigurations.Contains(ConfigFromUrl))
        {
            selectedConfiguration = ConfigFromUrl;
        }
        else if (availableConfigurations.Count > 0 && string.IsNullOrEmpty(selectedConfiguration))
        {
            // Only set default if no URL parameter was provided
            selectedConfiguration = availableConfigurations[0];
        }

        // Load from URL parameters if present
        if (BuildsFromUrl.HasValue && BuildsFromUrl.Value >= 1 && BuildsFromUrl.Value <= 20)
        {
            numberOfBuilds = BuildsFromUrl.Value;
        }

        // Load data after selection is finalized
        if (!filterApplied && !string.IsNullOrEmpty(selectedConfiguration))
        {
            sw.Restart();
            await RefreshData();
        }

        totalStopwatch.Stop();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Handle URL changes (browser back/forward)
        bool needsRefresh = false;
        
        if (!string.IsNullOrEmpty(ConfigFromUrl) && ConfigFromUrl != selectedConfiguration)
        {
            if (availableConfigurations.Contains(ConfigFromUrl))
            {
                selectedConfiguration = ConfigFromUrl;
                needsRefresh = true;
            }
        }
        
        if (BuildsFromUrl.HasValue && BuildsFromUrl.Value != numberOfBuilds)
        {
            numberOfBuilds = BuildsFromUrl.Value;
            needsRefresh = true;
        }

        if (!string.Equals(FeatureFromUrl, lastFeatureFromUrl, StringComparison.OrdinalIgnoreCase))
        {
            lastFeatureFromUrl = FeatureFromUrl;
            featureFromUrlApplied = false;
            if (historyResult != null)
            {
                ApplyFeatureFromUrlIfNeeded();
            }
        }
        
        if (needsRefresh)
        {
            await RefreshData();
        }
    }

    private async Task LoadAvailableConfigurations()
    {
        var sw = System.Diagnostics.Stopwatch.StartNew();
        try
        {
            configurationMetadata = await ConfigHistoryService.GetConfigurationsWithMetadataAsync();

            sw.Restart();
            availableConfigurations = configurationMetadata.Select(c => c.Id).ToList();
            // Don't set default here - let OnInitializedAsync handle it to respect URL params
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configurations: {ex.Message}", Severity.Error);
        }
    }



    private IEnumerable<ConfigurationMetadata> GetFilteredConfigurations()
    {
        if (string.IsNullOrEmpty(searchText))
            return configurationMetadata;
        
        return configurationMetadata
            .Where(x => x.Id.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private async Task SelectConfigurationFromDialog(string config)
    {
        selectedConfiguration = config;
        showConfigurationDialog = false;
        UpdateUrl();
        await RefreshData();
    }

    private void OpenConfigurationDialog()
    {
        searchText = string.Empty;
        showConfigurationDialog = true;
    }

    private void UpdateUrl()
    {
        var uri = NavigationManager.GetUriWithQueryParameters(new Dictionary<string, object?>
        {
            ["config"] = selectedConfiguration,
            ["builds"] = numberOfBuilds
        });
        NavigationManager.NavigateTo(uri, replace: true);
    }

    private async Task OnConfigurationChanged(string newConfig)
    {
        selectedConfiguration = newConfig;
        UpdateUrl();
        await RefreshData();
    }

    private async Task OnNumberOfBuildsChanged(int newValue)
    {
        numberOfBuilds = newValue;
        UpdateUrl();
        await RefreshData();
    }

    private async Task RefreshData()
    {
        if (string.IsNullOrEmpty(selectedConfiguration))
        {
            Snackbar.Add("Please select a configuration first", Severity.Warning);
            return;
        }

        var totalSw = System.Diagnostics.Stopwatch.StartNew();

        try
        {
            isLoading = true;

            var sw = System.Diagnostics.Stopwatch.StartNew();
            historyResult = await ConfigHistoryService.GetConfigurationHistoryAsync(selectedConfiguration, numberOfBuilds);

            ApplyFeatureFromUrlIfNeeded();

            Snackbar.Add("✅ Configuration history loaded", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration history: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
            totalSw.Stop();
        }
    }

    private void ExpandAll()
    {
        if (historyResult?.HierarchyNodes == null)
            return;

        // Count total nodes before expanding
        var totalNodes = CountAllNodes(historyResult.HierarchyNodes);

        if (totalNodes > MAX_EXPAND_ALL_NODES)
        {
            Snackbar.Add($"Cannot expand all - too many items ({totalNodes:N0} found). Limit: {MAX_EXPAND_ALL_NODES:N0} nodes. Please use filters or expand sections individually.", Severity.Warning, config =>
            {
                config.VisibleStateDuration = 6000;
            });
            return;
        }

        ExpandAllNodes(historyResult.HierarchyNodes);
        Snackbar.Add($"Expanded {totalNodes:N0} nodes", Severity.Success);
    }

    private void CollapseAll()
    {
        if (historyResult?.HierarchyNodes != null)
        {
            CollapseAllNodes(historyResult.HierarchyNodes);
            Snackbar.Add("Collapsed all nodes", Severity.Success);
        }
    }

    private int CountAllNodes(List<HierarchyNode> nodes)
    {
        var count = 0;
        foreach (var node in nodes)
        {
            count++; // Count this node
            count += CountAllNodes(node.Children); // Count children recursively
        }
        return count;
    }

    private void ExpandAllNodes(List<HierarchyNode> nodes)
    {
        foreach (var node in nodes)
        {
            node.IsExpanded = true;
            ExpandAllNodes(node.Children);
        }
    }

    private void CollapseAllNodes(List<HierarchyNode> nodes)
    {
        foreach (var node in nodes)
        {
            node.IsExpanded = false;
            CollapseAllNodes(node.Children);
        }
    }

    private void ToggleFailedFilter()
    {
        showOnlyFailed = !showOnlyFailed;
    }

    private void SelectTest(SelectedTestInfo testInfo)
    {
        selectedTestInfo = testInfo;
        showTestDetailsDialog = true;
    }

    private async Task CloseTestDetails()
    {
        selectedTestInfo = null;
        showTestDetailsDialog = false;
        await Task.CompletedTask;
    }

    private TestResult? GetSelectedTestResult()
    {
        if (selectedTestInfo?.TestNode == null) return null;
        
        var columnIndex = selectedTestInfo.ColumnIndex;
        var testNode = selectedTestInfo.TestNode;
        var historyCell = columnIndex < testNode.HistoryCells.Count ? testNode.HistoryCells[columnIndex] : null;
        
        return historyCell?.SourceTestResult;
    }

    private string? GetSelectedBuildId()
    {
        if (selectedTestInfo == null) return null;
        
        var columnIndex = selectedTestInfo.ColumnIndex;
        return columnIndex < historyResult?.HistoryColumns.Count 
            ? historyResult.HistoryColumns[columnIndex].BuildId 
            : "Unknown";
    }

    private List<TestResult>? GetTestHistory()
    {
        if (selectedTestInfo?.TestNode == null || historyResult?.HistoryColumns == null) return null;
        
        var testNode = selectedTestInfo.TestNode;
        var history = new List<TestResult>();
        
        for (int idx = 0; idx < testNode.HistoryCells.Count; idx++)
        {
            var cell = testNode.HistoryCells[idx];
            if (cell.SourceTestResult != null)
            {
                history.Add(cell.SourceTestResult);
            }
        }
        
        return history.Count > 0 ? history : null;
    }

    private void OpenFeatureDialog()
    {
        BuildFeatureGroups();
        showFeatureDialog = true;
    }

    private void ApplyFeatureFromUrlIfNeeded()
    {
        if (featureFromUrlApplied || string.IsNullOrWhiteSpace(FeatureFromUrl) || historyResult == null)
        {
            return;
        }

        BuildFeatureGroups();

        selectedFeatureNames.Clear();
        var knownFeatures = featureGroups.SelectMany(g => g.Value).ToHashSet(StringComparer.OrdinalIgnoreCase);
        var requested = FeatureFromUrl
            .Split(new[] { ',', '|' }, StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

        foreach (var feature in requested)
        {
            if (knownFeatures.Contains(feature))
            {
                selectedFeatureNames.Add(feature);
            }
        }

        if (selectedFeatureNames.Count == 0)
        {
            Snackbar.Add($"Feature not found in this view: {FeatureFromUrl}", Severity.Warning);
        }

        featureFromUrlApplied = true;
    }

    private void BuildFeatureGroups()
    {
        if (historyResult?.HierarchyNodes == null || historyResult.HierarchyNodes.Count == 0)
        {
            featureGroups.Clear();
            return;
        }

        var allFeatures = new List<string>();
        void CollectFeatures(HierarchyNode node)
        {
            if (node.NodeType == HierarchyNodeType.Feature)
            {
                allFeatures.Add(node.Name);
            }
            foreach (var child in node.Children)
            {
                CollectFeatures(child);
            }
        }

        foreach (var root in historyResult.HierarchyNodes)
        {
            CollectFeatures(root);
        }

        featureGroups = FeatureGroupingService.BuildFeatureGroups(allFeatures);
    }

    private void CloseFeatureDialog()
    {
        showFeatureDialog = false;
    }

    private void ApplyFeatureSelection()
    {
        showFeatureDialog = false;
        Snackbar.Add($"Applied {selectedFeatureNames.Count} feature(s)", Severity.Info);
        StateHasChanged();
    }


    private HierarchyNode? GetFilteredNode(HierarchyNode node)
    {
        // If feature filtering is active, drop entire feature branches that are not selected
        if (selectedFeatureNames.Any() && node.NodeType == HierarchyNodeType.Feature && !selectedFeatureNames.Contains(node.Name))
        {
            return null;
        }

        if (!showOnlyFailed)
        {
            // Start with a shallow copy
            var filteredNode = new HierarchyNode
            {
                Name = node.Name,
                NodeType = node.NodeType,
                NodeId = node.NodeId,
                IndentLevel = node.IndentLevel,
                IsExpanded = node.IsExpanded,
                ReportDirectoryPath = node.ReportDirectoryPath,
                TestFullName = node.TestFullName,
                WorkItemReferences = new List<WorkItemReference>(node.WorkItemReferences),
                HistoryCells = new List<HistoryCellData>(node.HistoryCells),
                LatestStats = new TestNodeStats
                {
                    Passed = node.LatestStats.Passed,
                    Failed = node.LatestStats.Failed,
                    Skipped = node.LatestStats.Skipped,
                },
                Children = new()
            };

            // Filter children based on feature selection
            foreach (var child in node.Children)
            {
                var filtered = GetFilteredNode(child);
                if (filtered != null)
                {
                    filteredNode.Children.Add(filtered);
                }
            }

            // Drop empty non-test nodes
            if (filteredNode.NodeType != HierarchyNodeType.Test && filteredNode.Children.Count == 0)
            {
                return null;
            }

            return filteredNode;
        }

        // Create a filtered copy that only shows failed tests
        var failureFilteredNode = new HierarchyNode
        {
            NodeId = node.NodeId,
            Name = node.Name,
            NodeType = node.NodeType,
            IndentLevel = node.IndentLevel,
            IsExpanded = node.IsExpanded,
            ReportDirectoryPath = node.ReportDirectoryPath,
            TestFullName = node.TestFullName,
                WorkItemReferences = new List<WorkItemReference>(node.WorkItemReferences),
            HistoryCells = new List<HistoryCellData>(node.HistoryCells),
            LatestStats = new TestNodeStats
            {
                Passed = node.LatestStats.Passed,
                Failed = node.LatestStats.Failed,
                Skipped = node.LatestStats.Skipped,
            },
            Children = new()
        };

        // Recursively filter children to only include those with failures
        foreach (var child in node.Children)
        {
            var filtered = FilterNodeForFailures(child);
            if (filtered != null)
            {
                failureFilteredNode.Children.Add(filtered);
            }
        }

        // Prune empty non-test nodes
        if (failureFilteredNode.NodeType != HierarchyNodeType.Test && failureFilteredNode.Children.Count == 0)
        {
            return null;
        }

        return failureFilteredNode;
    }

    private HierarchyNode? FilterNodeForFailures(HierarchyNode node)
    {
        // Respect feature selection
        if (selectedFeatureNames.Any() && node.NodeType == HierarchyNodeType.Feature && !selectedFeatureNames.Contains(node.Name))
        {
            return null;
        }

        // If it's a test node, check if it has any failures
        if (node.NodeType == HierarchyNodeType.Test)
        {
            var hasFailure = node.HistoryCells.Any(c => c.Status == HistoryCellStatus.HasFailures);
            if (!hasFailure)
            {
                return null;
            }
            return node; // Include the test
        }

        // For non-test nodes, recursively filter children
        var filteredNode = new HierarchyNode
        {
            Name = node.Name,
            NodeType = node.NodeType,
            IndentLevel = node.IndentLevel,
            IsExpanded = node.IsExpanded,
            ReportDirectoryPath = node.ReportDirectoryPath,
            TestFullName = node.TestFullName,
            WorkItemReferences = new List<WorkItemReference>(node.WorkItemReferences),
            HistoryCells = new List<HistoryCellData>(node.HistoryCells),
            LatestStats = new TestNodeStats
            {
                Passed = node.LatestStats.Passed,
                Failed = node.LatestStats.Failed,
                Skipped = node.LatestStats.Skipped,
            },
            Children = new()
        };

        foreach (var child in node.Children)
        {
            var filtered = FilterNodeForFailures(child);
            if (filtered != null)
            {
                filteredNode.Children.Add(filtered);
            }
        }

        // Only include this node if it has children after filtering
        return filteredNode.Children.Count > 0 ? filteredNode : null;
    }

    private void OpenSaveFilterDialog()
    {
        showSaveFilterDialog = true;
    }

    private SavedFilterConfiguration GetCurrentFilterState()
    {
        return new SavedFilterConfiguration
        {
            Name = string.Empty,  // Will be filled by dialog
            SavedBy = currentUsername,
            SavedDate = DateTime.UtcNow,
            SelectedConfiguration = selectedConfiguration,
            NumberOfBuilds = numberOfBuilds,
            Features = selectedFeatureNames.ToList(),
            Domains = new List<string>(),  // Can be extended later
            Versions = new List<string>(),
            NamedConfigs = new List<string>(),
            Machines = new List<string>(),
            OnlyFailures = showOnlyFailed
        };
    }

    private async Task OnFilterSaved(SavedFilterConfiguration savedFilter)
    {
        // Refresh the load filter dropdown to show the newly saved filter
        if (loadFilterDropdown != null)
        {
            await loadFilterDropdown.Refresh();
        }

        // Track last saved filter so user can share it
        lastAppliedFilterId = savedFilter.Id;
    }

    private async Task ApplyFilter(SavedFilterConfiguration filter)
    {
        lastAppliedFilterId = filter.Id;

        // Apply the loaded filter to the page state
        if (!string.IsNullOrEmpty(filter.SelectedConfiguration) && 
            availableConfigurations.Contains(filter.SelectedConfiguration))
        {
            selectedConfiguration = filter.SelectedConfiguration;
        }

        if (filter.NumberOfBuilds.HasValue)
        {
            numberOfBuilds = filter.NumberOfBuilds.Value;
        }

        if (filter.Features != null && filter.Features.Any())
        {
            selectedFeatureNames = filter.Features.ToHashSet();
        }
        else
        {
            selectedFeatureNames.Clear();
        }

        if (filter.OnlyFailures.HasValue)
        {
            showOnlyFailed = filter.OnlyFailures.Value;
        }

        // Reload data with the new filter settings
        await RefreshData();
    }

    private async Task<bool> ApplyFilterFromUrlAsync()
    {
        if (!FilterIdFromUrl.HasValue)
        {
            return false;
        }

        var filter = await UserDataService.LoadFilterAsync(FilterIdFromUrl.Value, currentUsername);
        if (filter == null)
        {
            Snackbar.Add($"Saved filter {FilterIdFromUrl.Value} not found", Severity.Warning);
            return false;
        }

        lastAppliedFilterId = FilterIdFromUrl.Value;
        await ApplyFilter(filter);
        return true;
    }

    private async Task CopyFilterLink(int filterId)
    {
        var targetId = filterId > 0 ? filterId : lastAppliedFilterId;
        if (!targetId.HasValue)
        {
            return;
        }

        var baseUri = NavigationManager.BaseUri.TrimEnd('/') + "/configuration-history";
        var url = $"{baseUri}?filterId={targetId.Value}";

        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", url);
            Snackbar.Add("Link copied to clipboard", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Failed to copy link", Severity.Error);
        }
    }
}

<style>
    .header-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .header-control {
        min-height: 42px;
    }

    .header-config {
        flex: 1 1 420px;
    }

    .builds-field {
        width: 140px;
    }

    .load-btn {
        width: 160px;
    }

    .slim-card .mud-card-content {
        padding: 8px;
    }

    .slim-card .mud-typography-h6 {
        font-size: 1rem;
    }

    .slim-card .mud-typography-caption {
        font-size: 0.82rem;
    }

    /* Bootstrap modal styling */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
        width: 100%;
        height: 100%;
        overflow: hidden;
        outline: 0;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1040;
        width: 100vw;
        height: 100vh;
        background-color: #000;
        opacity: 0.5;
    }

    .modal-dialog {
        position: relative;
        width: auto;
        margin: 1.75rem auto;
    }

    .modal-dialog-sm {
        max-width: 300px;
    }

    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        pointer-events: auto;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 0.3rem;
        outline: 0;
    }

    .modal-header {
        display: flex;
        flex-shrink: 0;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-title {
        margin-bottom: 0;
        line-height: 1.5;
        font-size: 1.25rem;
        font-weight: 500;
    }

    .modal-body {
        position: relative;
        flex: 1 1 auto;
        padding: 1rem;
    }

    .modal-footer {
        display: flex;
        flex-wrap: wrap;
        flex-shrink: 0;
        align-items: center;
        justify-content: flex-end;
        padding: 0.75rem;
        border-top: 1px solid #dee2e6;
        border-bottom-right-radius: calc(0.3rem - 1px);
        border-bottom-left-radius: calc(0.3rem - 1px);
    }

    .btn-close {
        box-sizing: content-box;
        width: 1em;
        height: 1em;
        padding: 0.25em 0.25em;
        color: #000;
        background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e") center / 1em auto no-repeat;
        border: 0;
        border-radius: 0.25rem;
        cursor: pointer;
        opacity: 0.5;
    }

    .btn-close:hover {
        opacity: 0.75;
    }

    .btn {
        display: inline-block;
        font-weight: 400;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        user-select: none;
        border: 1px solid transparent;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: 0.25rem;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        cursor: pointer;
    }

    .btn-primary {
        color: #fff;
        background-color: #007bff;
        border-color: #007bff;
    }

    .btn-primary:hover {
        color: #fff;
        background-color: #0056b3;
        border-color: #004085;
    }

    .btn-secondary {
        color: #fff;
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .btn-secondary:hover {
        color: #fff;
        background-color: #545b62;
        border-color: #4e555b;
    }

    .btn-info {
        color: #fff;
        background-color: #17a2b8;
        border-color: #17a2b8;
    }

    .btn-info:hover {
        color: #fff;
        background-color: #138496;
        border-color: #117a8b;
    }
</style>
