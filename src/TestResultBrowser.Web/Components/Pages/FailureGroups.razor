@page "/failure-groups"
@rendermode InteractiveServer
@using TestResultBrowser.Web.Models
@using MudBlazor
@using Microsoft.Extensions.Caching.Memory
@inject ITestDataService TestData
@inject IFailureGroupingService Grouping
@inject ISnackbar Snackbar
@inject ILogger<FailureGroups> Logger
@inject IMemoryCache Cache
@implements IDisposable

<PageTitle>Failure Groups</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-3 mb-3">
        <MudText Typo="Typo.h5">Failure Grouping by Root Cause</MudText>
        <MudText Typo="Typo.body2" Color="Color.Default">Clusters failed tests by similar error messages to identify common root causes.</MudText>
        <MudDivider Class="my-2" />
        <MudGrid Class="mb-2">
            <MudItem xs="12" sm="6" md="2">
                <MudNumericField @bind-Value="similarityThresholdPercent" @bind-Value:after="OnFilterChanged" Min="50" Max="100" Label="Similarity Threshold (%)" />
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudNumericField @bind-Value="lastXDays" @bind-Value:after="OnFilterChanged" Min="1" Max="365" Label="Last X Days" />
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudSelect @bind-Value="itemsPerPage" @bind-Value:after="OnPageSizeChanged" Label="Groups Per Page">
                    <MudSelectItem Value="10">10</MudSelectItem>
                    <MudSelectItem Value="25">25</MudSelectItem>
                    <MudSelectItem Value="50">50</MudSelectItem>
                    <MudSelectItem Value="100">100</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Primary" 
                          OnClick="OpenConfigurationDialog"
                          FullWidth="true"
                          Style="height: 56px; text-align: left; justify-content: flex-start;">
                    <div style="width: 100%;">
                        @{
                            var configCount = string.IsNullOrEmpty(selectedConfiguration) 
                                ? availableConfigurations.Count 
                                : 1;
                        }
                        <div style="font-size: 0.75rem; color: #666;">Configuration [@configCount/@availableConfigurations.Count]</div>
                        <div style="font-weight: 500;">@(string.IsNullOrEmpty(selectedConfiguration) ? "All Configurations" : selectedConfiguration)</div>
                    </div>
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Refresh" Disabled="isLoading">
                    @if (isLoading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    }
                    else
                    {
                        <span>Refresh</span>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (groups is null)
    {
        <MudPaper Class="pa-6 d-flex flex-column align-center">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Typo="Typo.h6" Class="mt-4">Loading failure groups...</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Analyzing failed tests...
            </MudText>
        </MudPaper>
    }
    else if (groups.Count == 0)
    {
        <MudAlert Severity="Severity.Info">No failed tests found or no groups at current threshold.</MudAlert>
    }
    else
    {
        <MudExpansionPanels MultiExpanded="true" Class="mt-3">
            @foreach (var group in displayedGroups)
            {
                <MudExpansionPanel IsInitiallyExpanded="false" Text="@($"{group.TestCount} - {group.RepresentativeMessage}")">
                    <ChildContent>
                        <MudExpansionPanels MultiExpanded="true" Class="ms-4">
                            @{
                                var testGroups = group.TestResults
                                    .GroupBy(t => t.TestFullName)
                                    .OrderByDescending(gr => gr.Count())
                                    .Select(testGroup => new GroupedTest
                                    {
                                        TestName = testGroup.Key,
                                        Count = testGroup.Count(),
                                        DateGroups = testGroup
                                            .GroupBy(t => t.Timestamp.Date)
                                            .OrderByDescending(dg => dg.Key)
                                            .Select(dateGroup => new GroupedByDate
                                            {
                                                Date = dateGroup.Key,
                                                Count = dateGroup.Count(),
                                                Results = dateGroup.OrderByDescending(t => t.Timestamp).ToList()
                                            })
                                            .ToList()
                                    })
                                    .ToList();
                            }
                            @foreach (var test in testGroups)
                                {
                                    var latestResult = GetLatestResult(test);
                                    <MudExpansionPanel IsInitiallyExpanded="false">
                                        <TitleContent>
                                            <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
                                                <span>@test.TestName (@test.Count occurrences)</span>
                                                @if (latestResult != null)
                                                {
                                                    <span style="color:#1976d2; cursor:pointer; text-decoration:underline; font-size:0.85rem;"
                                                          @onclick="(() => OpenTestDetails(latestResult))"
                                                          @onclick:stopPropagation="true">
                                                        Open details
                                                    </span>
                                                }
                                            </div>
                                        </TitleContent>
                                        <ChildContent>
                                            <div class="ms-4">
                                                <table class="table table-sm failure-table">
                                                    <thead>
                                                        <tr>
                                                            <th class="col-date">Date</th>
                                                            <th class="col-build">Build</th>
                                                            <th class="col-domain">Domain</th>
                                                            <th class="col-feature">Feature</th>
                                                            <th class="col-config">Configuration</th>
                                                            <th class="col-seen">Last seen</th>
                                                            <th class="col-error">Error</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var row in GetTestRows(test))
                                                        {
                                                            <tr>
                                                                <td>@row.Date.ToString("yyyy-MM-dd")</td>
                                                                <td>@row.Result.BuildId</td>
                                                                <td>@row.Result.DomainId</td>
                                                                <td>@row.Result.FeatureId</td>
                                                                <td class="cell-config">@row.Result.ConfigurationId</td>
                                                                <td>@row.Result.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                                                <td class="cell-error" title="@row.Result.ErrorMessage">
                                                                    @row.Result.ErrorMessage
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </ChildContent>
                                    </MudExpansionPanel>
                                }
                            </MudExpansionPanels>
                    </ChildContent>
                </MudExpansionPanel>
            }
        </MudExpansionPanels>

        @if (totalPages > 1)
        {
            <MudPaper Class="pa-3 mt-3 d-flex justify-center align-center">
                <MudPagination
                    Count="@totalPages"
                    Selected="@currentPage"
                    SelectedChanged="OnPageChanged"
                    Color="Color.Primary"
                    ShowFirstButton="true"
                    ShowLastButton="true" />
                <MudText Class="ml-4" Typo="Typo.body2">
                    Showing @((currentPage - 1) * itemsPerPage + 1)-@Math.Min(currentPage * itemsPerPage, groups?.Count ?? 0) of @(groups?.Count ?? 0) groups
                </MudText>
            </MudPaper>
        }
    }
</MudContainer>

<ConfigurationSelector 
    IsOpen="@showConfigurationDialog" 
    IsOpenChanged="@((bool value) => showConfigurationDialog = value)"
    SelectedConfiguration="@selectedConfiguration"
    SelectedConfigurationChanged="@((string value) => SelectConfigurationFromDialog(value))"
    AvailableConfigurations="@availableConfigurations" />

<TestDetailsModal IsOpen="@showTestDetailsModal"
                  TestResult="@selectedTestResult"
                  BuildId="@selectedTestBuildId"
                  History="@selectedTestHistory"
                  OnClose="@CloseTestDetails" />

@code {
    // Cache key prefix for this component
    private const string CacheKeyPrefix = "FailureGroups_";
    private string _cacheKey => $"{CacheKeyPrefix}{selectedConfiguration}_{lastXDays}_{similarityThresholdPercent}";
    private List<FailureGroup>? groups => Cache.Get<List<FailureGroup>>(_cacheKey);

    private bool isLoading = false;
    private int similarityThresholdPercent = 80;
    private int lastXDays = 30;
    private string selectedConfiguration = string.Empty;
    private List<string> availableConfigurations = new();
    private bool showConfigurationDialog = false;
    private Timer? _debounceTimer;

    // Pagination state
    private int currentPage = 1;
    private int itemsPerPage = 25;
    private int totalPages => groups != null ? (int)Math.Ceiling(groups.Count / (double)itemsPerPage) : 0;
    private List<FailureGroup> displayedGroups => groups?.Skip((currentPage - 1) * itemsPerPage).Take(itemsPerPage).ToList() ?? new();

    private bool showTestDetailsModal;
    private TestResult? selectedTestResult;
    private string? selectedTestBuildId;
    private List<TestResult>? selectedTestHistory;

    private class GroupedTest
    {
        public string TestName { get; set; } = string.Empty;
        public int Count { get; set; }
        public List<GroupedByDate> DateGroups { get; set; } = new();
    }

    private class GroupedByDate
    {
        public DateTime Date { get; set; }
        public int Count { get; set; }
        public List<TestResult> Results { get; set; } = new();
    }

    protected override async Task OnInitializedAsync()
    {
        availableConfigurations = TestData.GetAllConfigurationIds().ToList();
        if (availableConfigurations.Count > 0)
        {
            selectedConfiguration = availableConfigurations[0];
        }
        await Refresh();
    }

    private void OpenConfigurationDialog()
    {
        showConfigurationDialog = true;
    }

    private async Task SelectConfigurationFromDialog(string config)
    {
        selectedConfiguration = config;
        showConfigurationDialog = false;
        await Refresh();
    }

    private void OnFilterChanged()
    {
        // Debounce filter changes to avoid excessive re-grouping on large datasets
        _debounceTimer?.Dispose();
        _debounceTimer = new Timer(_ => InvokeAsync(async () => await Refresh()), null, 500, Timeout.Infinite);
    }

    private async Task Refresh()
    {
        isLoading = true;
        await InvokeAsync(StateHasChanged); // Yield to render loading indicator before heavy processing
        
        try
        {
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(30));
            var groupingTask = Task.Run(() =>
            {
                var token = cts.Token;
                token.ThrowIfCancellationRequested();

                var allFailed = TestData.GetAllTestResults().Where(tr => tr.Status == TestStatus.Fail);

                // Filter by date range (use UTC to match TestResult.Timestamp)
                var cutoffDate = DateTime.UtcNow.AddDays(-lastXDays);
                var filtered = allFailed.Where(tr => tr.Timestamp >= cutoffDate);

                // Filter by configuration if selected
                if (!string.IsNullOrEmpty(selectedConfiguration))
                {
                    filtered = filtered.Where(tr => tr.ConfigurationId == selectedConfiguration);
                }

                token.ThrowIfCancellationRequested();

                // Materialize to avoid multiple enumeration
                var filteredList = filtered.ToList();

                var threshold = Math.Clamp(similarityThresholdPercent, 50, 100) / 100.0;
                token.ThrowIfCancellationRequested();
                var fullGroups = Grouping.GroupFailures(filteredList, threshold);

                return (fullGroups, filteredList.Count, threshold);
            }, cts.Token);

            var completed = await Task.WhenAny(groupingTask, Task.Delay(TimeSpan.FromSeconds(30)));
            if (completed != groupingTask)
            {
                cts.Cancel();
                Logger.LogWarning("Failure group loading timed out after 30 seconds.");
                Snackbar.Add("Failure group loading timed out after 30 seconds.", Severity.Error);
                try
                {
                    await groupingTask;
                }
                catch (OperationCanceledException)
                {
                    // Expected when timing out.
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Failure group loading failed after timeout.");
                }
                return;
            }

            var (fullGroups, failureCount, threshold) = await groupingTask;

            // Store in IMemoryCache with expiration to avoid unbounded growth
            Cache.Set(_cacheKey, fullGroups, TimeSpan.FromMinutes(30));
            currentPage = 1; // Reset to first page on refresh

            Logger.LogInformation("Grouped {GroupCount} failure groups from {FailureCount} tests at {Threshold:P0} similarity",
                fullGroups?.Count ?? 0, failureCount, threshold);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing failure groups");
            Snackbar.Add($"Error loading failures: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OnPageChanged(int newPage)
    {
        currentPage = newPage;
    }

    private void OnPageSizeChanged()
    {
        currentPage = 1; // Reset to first page when page size changes
    }

    private TestResult? GetLatestResult(GroupedTest testGroup)
    {
        return testGroup.DateGroups
            .SelectMany(group => group.Results)
            .OrderByDescending(result => result.Timestamp)
            .FirstOrDefault();
    }

    private List<(DateTime Date, TestResult Result)> GetTestRows(GroupedTest testGroup)
    {
        return testGroup.DateGroups
            .SelectMany(group => group.Results.Select(result => (group.Date, Result: result)))
            .OrderByDescending(row => row.Result.Timestamp)
            .ToList();
    }

    private void OpenTestDetails(TestResult testResult)
    {
        if (string.IsNullOrWhiteSpace(testResult.TestFullName) || string.IsNullOrWhiteSpace(testResult.ConfigurationId))
        {
            return;
        }

        selectedTestResult = testResult;
        selectedTestBuildId = testResult.BuildId;
        selectedTestHistory = TestData.GetTestResultsByTestName(testResult.TestFullName)
            .Where(r => string.Equals(r.ConfigurationId, testResult.ConfigurationId, StringComparison.OrdinalIgnoreCase))
            .OrderByDescending(r => r.Timestamp)
            .ToList();
        showTestDetailsModal = true;
    }

    private Task CloseTestDetails()
    {
        showTestDetailsModal = false;
        selectedTestResult = null;
        selectedTestBuildId = null;
        selectedTestHistory = null;
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}

<style>
    .failure-table {
        font-size: 0.85rem;
        table-layout: auto;
        width: 100%;
    }

    .failure-table th,
    .failure-table td {
        vertical-align: top;
        padding: 4px 6px;
    }

    .failure-table .col-date { width: 90px; }
    .failure-table .col-build { width: 100px; }
    .failure-table .col-domain { width: 120px; }
    .failure-table .col-feature { width: 220px; }
    .failure-table .col-config { width: 180px; }
    .failure-table .col-seen { width: 140px; }
    .failure-table .col-error { width: 260px; }

    .failure-table td {
        word-break: break-word;
        white-space: normal;
    }

    .failure-table .cell-error {
        max-width: 260px;
        white-space: normal;
        overflow-wrap: anywhere;
    }

    .failure-table .cell-config {
        word-break: break-all;
    }
</style>
